<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<meta name="_scss" content="assets/scss/_/">
		<meta name="vg.api" content="http://192.168.100.97/Visagate">
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		
		<style type="text/css">
			* {
				box-sizing: border-box;
				font-family: system-ui, sans;
			}
			
			.autocomplete-input {
				width: 100%;
				
			}
			
			.autocomplete-results-anchor {
				position: relative;
				width: 100%;
			}
			
			.autocomplete-results {
				position: absolute;
				width: 100%;
				border: solid 1px #CCC;
				border-radius: 5px;
				padding: .3rem 0;
				top: 10px;
				z-index: 5;
				background: #FFF;
			}
			
			.autocomplete-results.autocomplete-hidden {
				display: none;
			}
			
			.autocomplete-results .autocomplete-result {
				white-space: nowrap;
				color: #555;
				padding: .5rem .9rem;
				font-size: .8rem;
				cursor: pointer;
			}
			
			.autocomplete-results .autocomplete-result:hover {
				color: #FFF;
				background-color: #44a5eb;
			}
		</style>

		<script src="assets/js/m3/depend.js" type="text/javascript"></script>
		<script src="assets/js/m3/depend/router.js" type="text/javascript"></script>

		<script type="text/javascript">
		(function () {
			depend(['m3/depend/router'], function(router) {
				var location = document.querySelector('meta[name="_scss"]').getAttribute('content') || '/assets/scss/_/js/';
				router.all().to(function(e) { return 'assets/js/' + e + '.js'; });
				router.equals('_scss').to( function() { return 'assets/scss/_/js/_.scss.js'; });

				router.startsWith('_scss/').to(function(str) {
					return location + str.substring(6) + '.js';
				});
			});
		}());
		</script>
	</head>
	<body>
		
		<div style="max-width: 500px; margin: 100px auto;">
			<input type="hidden" name="country" class="autocomplete-target">
			<div class="spacer" style="height:10px"></div>
			<input type="hidden" name="passport" class="autocomplete-passport">
			<div class="spacer" style="height:10px"></div>
			<div style="text-align: right">
				<select id="language">
					<option value="de">Deutsch</option>
					<option value="en">English</option>
				</select>
				<select id="reason">
					<option value="tourist">Tourist</option>
					<option value="business">Gesch&auml;ftlich</option>
					<option value="student">Student</option>
				</select>
				<input type="submit" id="country-submit" disabled value="Next">
			</div>
		</div>

		<noscript>
			<select>
				<!-- Foreach country -->
			</select>
		</noscript>
		
		<div id="output" style="max-width: 500px; margin: 100px auto; color: #777; font-size: .8em"></div>
		<div id="vg-recommendations" style="max-width: 500px; margin: 100px auto;"></div>

		<script type="text/javascript">
			
		var api = document.querySelector('meta[name="vg.api"]').content;
		
		//Application logic
		depend(['autocomplete', 'm3/core/request'], function (autocomplete, request) {
			autocomplete(document.querySelector('.autocomplete-target'), function (input, output) {
				request(api + '/search/find/country/' + input + '.json?hl=' + document.querySelector('#language').value)
				.then(JSON.parse)
				.then(function (r) {
					var ret = {};
					var c = 0;
					
					for (var i in r) {
						if (!r.hasOwnProperty(i)) { continue; }
						if (c > 5) { continue; }
						ret[r[i].resource] = r[i].name;
						c++;
					}
					output(ret);
				});
			});
			
			autocomplete(document.querySelector('.autocomplete-passport'), function (input, output) {
				request(api + '/search/find/document/' + input + '.json?hl=' + document.querySelector('#language').value)
				.then(JSON.parse)
				.then(function (r) {
					var ret = {};
					var c = 0;
					console.log(r);
					
					for (var i in r) {
						if (!r.hasOwnProperty(i)) { continue; }
						if (c > 5) { continue; }
						ret[r[i].resource] = r[i].name;
						c++;
					}
					output(ret);
				});
			});
			
			document.getElementById('country-submit').addEventListener('click', function () {
				request(api + '/itinerary/test.json?hl=' + document.querySelector('#language').value, {
					people: [{name: 'Test', documents: [document.querySelector('.autocomplete-passport').value]}],
					stops: [{country: document.querySelector('.autocomplete-target').value, reason: document.querySelector('#reason').value}]
				})
					.then(function (e) { document.getElementById('output').innerHTML = e; return e;})
					.then(JSON.parse)
					.then(function (r) {
						var recs = document.querySelector('#vg-recommendations');
						recs.innerHTML = '';
						
						for (var i = 0; i < r.payload.length; i++) {
							recs.appendChild(document.createElement('div')).innerHTML = r.payload[i].name;
							
							for (var j in r.payload[i].stops) {
								if (!r.payload[i].stops.hasOwnProperty(j)) { continue; }
								recs.appendChild(document.createElement('div')).innerHTML = j;
								
								for (var k = 0; k < r.payload[i].stops[j].candidates.length; k++) {
									console.log(r.payload[i].stops[j].candidates[k]);
									var e = recs.appendChild(document.createElement('a'));
									e.href = r.payload[i].stops[j].candidates[k][0].product.url;
									e.style.display = 'block';
									e.innerHTML = r.payload[i].stops[j].candidates[k][0].name + (r.payload[i].stops[j].candidates[k][0].product.price.amt / 100);
								}
							}
						}
						console.log(r);
					});
			}, false);
		});
		</script>
		
		<script type="text/javascript">
		(function () {
			var input = document.querySelector('.autocomplete-target');
			var button = document.querySelector('#country-submit');
			
			input.addEventListener('change', function () {
				console.log('aslkalks');
				if (input.value === '') { button.setAttribute('disabled', 'disabled'); }
				else { button.removeAttribute('disabled'); }
			}, false);
		}());
		</script>
	</body>
</html>
