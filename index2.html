<!DOCTYPE html>
<html>
	<head>
		<title>Visa-Gate Widget</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<meta name="_scss" content="assets/scss/_/">
		<meta name="vg.api" content="http://192.168.100.97/Visagate">
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		
		<link rel="stylesheet" type="text/css" href="assets/css/app.css" >
		
		<script src="assets/js/m3/depend.js" type="text/javascript"></script>
		<script src="assets/js/m3/depend/router.js" type="text/javascript"></script>

		<script type="text/javascript">
		(function () {
			depend(['m3/depend/router'], function(router) {
				var location = document.querySelector('meta[name="_scss"]').getAttribute('content') || '/assets/scss/_/js/';
				router.all().to(function(e) { return 'assets/js/' + e + '.js'; });
				router.equals('_scss').to( function() { return 'assets/scss/_/js/_.scss.js'; });

				router.startsWith('_scss/').to(function(str) {
					return location + str.substring(6) + '.js';
				});
			});
		}());
		</script>
	</head>
	<body>
		<div class="spacer" style="height: 100px"></div>
		
		<div class="row l2">
			<div class="span l1">
				<div class="wrapper">
					<div class="spacer" style="height: 4px"></div>
					<div id="passports"></div>
					<div class="spacer" style="height: 8px"></div>
					<div class="separator"></div>
					<div class="spacer" style="height: 8px"></div>
					<div id="destination"></div>
					
				</div>
				<div class="wrapper transparent" id="country-error">
					<div class="spacer" style="height: 10px"></div>
					<div class="info-message">
						Please select at least one country to continue.
					</div>
				</div>
				<div class="spacer" style="height: 50px"></div>
				<div id="output" style="display: none;"></div>
			</div>
			<div class="span l1 desktop-only">
				<div id="map"></div>
				<div class="spacer" style="height: 50px"></div>
				<div class="wrapper" style="padding: 10px 0 0 0">
					<div id="regulations"></div>
				</div>
			</div>
		</div>
		
		<div class="spacer" style="height: 20px"></div>
		
		<div class="wrapper">
		</div>




		
		<script type="text/javascript">
			depend(
				['country.multiple', 'people.multiple', 'visa.output', 'regulations.output', 'map', 'pipe', 'm3/promises/promise', 'm3/core/request', 'm3/core/collection'], 
				function (target, people, visa, regout, map, pipe, Promise, request, collect) {
				
				var api = document.querySelector('meta[name="vg.api"]').content;
				var targets = undefined;
				var visaOut = undefined;
				var peopleP = undefined;
				var regoutP = undefined;
				var mapoutP = undefined;
				
				var main = function () {
					
					var validation = pipe(function (input, output) { 
						
						var _ret = {people : [], stops: []};
						
						if (input[0]) for (var i = 0; i < input[0].length; i++) {
							var item = input[0][i];
							
							if (item === undefined || !item.ISO || item.ISO === '') {
								console.log('Input is empty');
							}
							
							else {
								_ret.stops.push(item);
							}
						}
						
						if(input[1]) for (var i = 0; i < input[1].length; i++) {
							var item = input[1][i];
							
							if (item === undefined || !item.document || item.document === '') {
								console.log('Input is empty');
							}
							
							else {
								_ret.people.push(item);
							}
						}

						if (_ret.people.length > 0 && _ret.stops.length > 0) {
							output(_ret);
							document.getElementById('output').style.display = 'block';
						}
						else {
							document.getElementById('output').style.display = 'none';
						}

						if (_ret.stops.length > 0) {
							document.getElementById('country-error').style.display = 'none';
							document.getElementById('add-stop').style.display = 'block';
						}
						else {
							document.getElementById('add-stop').style.display = 'none';
							document.getElementById('country-error').style.display = 'block';
						}
					});
					
					var apiCall = pipe(function (input, output) {
						console.log('API CALL');
						console.log(input);
						var people = input[0].people;
						var stops = input[0].stops;
						
						
						
						request(api + '/itinerary/test.json', {
							people: collect(people).each(function (e) { return {name: e.name, documents: [e.document]}; }).raw(),
							stops: collect(stops).each(function (e) { return { country: e.ISO, reason: e.reason }; }).raw()
						})
						.then(JSON.parse)
						.then(function (payload) {
							output(payload.payload);
						});
					});
					
					var regulations = pipe(function (input, output) {
						console.log('REGULATIONS CALL');
						console.log(input);
						var stops = input[0];
						var isos = collect(stops).each(function (e) { return e.ISO; } ).raw();
						
						if (isos.length === 0) { return; }
						
						request(api + '/country/regulations/' + isos.join(':') + '.json')
							.then(JSON.parse)
							.then(function (payload) {
								output(payload.payload);
							});
					});
					
					var output = pipe(function (input, output) {
						console.log(input);
					});
					
					validation.receive([targets, peopleP]);
					apiCall.receive([validation]);
					visaOut.receive([apiCall]);
					regulations.receive([targets]);
					regoutP.receive([regulations]);
					mapoutP.receive([targets]);
					
					console.log([validation, apiCall, visaOut, regulations, regoutP, mapoutP]);
				};
				
				people.init(document.getElementById('passports'), api)
					.then(function (p) { peopleP = p; return target.init(document.getElementById('destination'), api); })
					.then(function (p) { targets = p; return visa.init(document.getElementById('output'), api); })
					.then(function (p) { visaOut = p; return map.init(document.getElementById('map'), api); })
					.then(function (p) { mapoutP = p; return regout.init(document.getElementById('regulations'), api); })
					.then(function (p) { regoutP = p; main(); console.log('Success'); });
				
			});
		</script>
	</body>
</html>
