<!DOCTYPE html>
<html>
	<head>
		<title>Visa-Gate Widget</title>
		<meta name="viewport" content="width=device-width,initial-scale=1.0">
		<meta name="_scss" content="assets/scss/_/">
		<meta name="vg.api" content="http://192.168.100.97/Visagate">
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		
		<link rel="stylesheet" type="text/css" href="assets/css/app.css" >
		
		<script src="assets/js/m3/depend.js" type="text/javascript"></script>
		<script src="assets/js/m3/depend/router.js" type="text/javascript"></script>

		<script type="text/javascript">
		(function () {
			depend(['m3/depend/router'], function(router) {
				var location = document.querySelector('meta[name="_scss"]').getAttribute('content') || '/assets/scss/_/js/';
				router.all().to(function(e) { return 'assets/js/' + e + '.js'; });
				router.equals('_scss').to( function() { return 'assets/scss/_/js/_.scss.js'; });

				router.startsWith('_scss/').to(function(str) {
					return location + str.substring(6) + '.js';
				});
			});
		}());
		</script>
	</head>
	<body>
		<div class="spacer" style="height: 100px"></div>

		<!-- The stops element contains the previous stops the user wishes to make-->
		<div id="stops">

		</div>

		<div  class="wrapper" id="target-country" >
			<div id="map" style="background-color: #01b1d7; padding:16px;">
				<img src="assets/img/map.svg" alt="World map">
				<div class="discovery-form-header" id="marker" >
					<span class="dot" style="display: none"></span>
					<span class="country" id="label">Wohin moechten sie reisen?</span>
				</div>
			</div>

			<form class="discovery-form" id="target-country-form" >
				<!-- Here goes the form -->
				<input type="hidden" name="country" class="autocomplete-target target" id="target">
				<div class="spacer" style="height: 10px"></div>
				<select id="reason">
					<option value="tourist">Tourist / Urlauber</option>
					<option value="business">Business</option>
				</select>

				<div class="spacer" style="height: 20px"></div>

				<div style="text-align: right">
					<a href="#add-stop" id="add-stop">Weiteres Land</a>
					<input type="submit">
				</div>

				<div class="spacer" style="height: 10px"></div>
			</form>
		</div>

		<div class="spacer" style="height: 30px"></div>

		<div class="wrapper" id="nationality">
			<template id="passenger">
				<div class="person">
					<img class="avatar">
					<span class="person-name"></span>
					<img class="flag">
					<input type="hidden" name="passport" class="passport-country">
				</div>
			</template>

			<div class="spacer" style="height: 10px"></div>

			<form class="discovery-form" id="nationality-form">
				<div style="display: inline-block; width: 10%; height: 20px; float: left">
					<img class="avatar" src="https://api.adorable.io/avatars/285/">
				</div>
				<div style="display: inline-block; width: 50%; float: left">
					<input type="text" name="name" id="passport-name">
				</div>

				<div style="display: inline-block; width: 40%; float: left">
					<input type="hidden" name="passport" class="autocomplete-passport" id="passport-country">
				</div>

				<div style="clear: both"></div>

				<div class="spacer" style="height: 20px"></div>

				<div style="text-align: right">
					<a href="#add-person" id="add-person">Weitere Person</a>
					<input type="submit">
				</div>
			</form>
		</div>

		<div class="spacer" style="height: 30px"></div>

		<div  id="visa-results">
			
			<div id="vg-recommendations" style="max-width: 500px; margin: 0 auto;"></div>
			<div id="output"></div>
			<h2>User A</h2>
			<div class="wrapper">
				<div class="visa-result">
					<a class="buy-now">$135.00</a>
					<span class="title">Indien</span>
					<span class="description">90 Tage touristen eVisum</span>
				</div>

				<div class="separator"></div>

				<div class="visa-result">
					<a class="buy-now" href="//visa-gate.com">$39.00</a>
					<span class="title">Russland</span>
					<span class="description">30 Tage touristen eVisum</span>
				</div>
			</div>

			<div class="spacer" style="height: 20px"></div>

			<h2>User B</h2>
			<div class="wrapper">
				<div class="visa-result">
					<a class="buy-now">$135.00</a>
					<span class="title">Indien</span>
					<span class="description">90 Tage touristen eVisum</span>
				</div>

				<div class="separator"></div>

				<div class="visa-result">
					<a class="buy-now unneeded" href="//visa-gate.com">Nich benoetigt</a>
					<span class="title">Russland</span>
					<span class="description">30 Tage touristen eVisum</span>
				</div>
			</div>

			<div class="spacer" style="height: 50px"></div>

			<div class="wrapper">
				<a href="#buy-now" class="buy-now" style="width: 100%; padding: .7rem 1.3rem; text-align:center; font-size: 1.2rem;">Alle kaufen</a>
				<div style="clear: both"></div>
			</div>

			<div class="spacer" style="height: 50px"></div>

			<h2>Was du wissen solltest</h2>

			<div class="wrapper">
				<div class="visa-result">
					<span class="title">Indien</span>
				</div>

				<div class="considerations">
					<div class="consideration">
						<img class="icon" src="assets/img/considerations/health.png">
						<span class="caption">Gelbfieber Impfung</span>
						<span class="description">Wenn sie aus einem Land mit Gelbfieber kommen</span>
					</div>
						<div class="consideration">
							<img class="icon" src="assets/img/considerations/customs.png">
							<span class="caption">Zollbeschrenkung Bargeld</span>
							<span class="description">Wenn sie mit mehr als â‚¹35000, sind sie anmeldepflichtig</span>
						</div>
				</div>

				<div class="separator"></div>

				<div class="visa-result">
					<span class="title">Russland</span>
				</div>
				<div class="considerations">
					<div class="consideration">
						<img class="icon" src="assets/img/considerations/customs.png">
						<span class="caption">Tabak</span>
						<span class="description">Nicht mehr als 200; nur Erwachsene</span>
					</div>
					<div class="consideration">
						<img class="icon" src="assets/img/considerations/passport.png">
						<span class="caption">Amerikanischer Pass</span>
						<span class="description">Dimitri nicht erlauben Americano!</span>
					</div>
				</div>
			</div>
		</div>

		<div class="spacer" style="height: 100px"></div>

		<script>
		(function () {
			var map = document.getElementById('map');
			var lbl = document.getElementById('label');
			var rsn = document.getElementById('reason');
			var dot = document.getElementById('marker');
			var sel = document.getElementById('target');

			var tfrm = document.getElementById('target-country-form');
			var twrp = document.getElementById('target-country');
			var nwrp = document.getElementById('nationality');
			var vwrp = document.getElementById('visa-results');
			var nfrm = document.getElementById('nationality-form');
			var ppct = document.getElementById('passport-country');
			var ppnm = document.getElementById('passport-name');

			function addPerson() {
				var template = document.getElementById("passenger");
				var clone = document.importNode(template.content, true);

				clone.querySelector('.avatar').src = nfrm.querySelector('.avatar').src;
				clone.querySelector('.person-name').innerHTML = ppnm.value;
				clone.querySelector('.passport-country').value = ppct.value;
				clone.querySelector('.flag').src = "https://lipis.github.io/flag-icon-css/flags/1x1/" + ppct.value.substr(1).toLowerCase() + ".svg";

				ppnm.value = '';

				template.parentNode.insertBefore(clone, template);
			}

			sel.addEventListener('change', function (e) {
				var opt = this.options[this.selectedIndex];

				lbl.innerHTML = this.options[this.selectedIndex].value;
				dot.querySelector('.dot').style.display = null;

				//Get the base values
				var x = opt.getAttribute('data-map-x');
				var y = opt.getAttribute('data-map-y');

				//Correct for the map's offset
				//x = x - map.clientWidth / 2 + lbl.clientWidth / 2;
				//y = y - 50;

				dot.style.left = `${x}%`;
				dot.style.top = `${y}%`;
			}, false);

			rsn.addEventListener('change', function () {
				var opt = this.options[this.selectedIndex].value === 'business'? 'add' : 'remove';
				dot.querySelector('.dot').classList[opt]('business');
			});

			tfrm.addEventListener('submit', function (e) {
				e.preventDefault();
				e.stopPropagation();

				twrp.classList.add('collapsed');
				nwrp.style.height = 'auto';
				nfrm.style.height = nfrm.scrollHeight + 'px';
			});

			nfrm.addEventListener('submit', function (e) {
				e.preventDefault();

				addPerson();

				nfrm.style.height = '0px';
				nfrm.style.padding = '0px 1.3rem';
				vwrp.style.height = vwrp.scrollHeight + 20 + 'px';
			});

			ppnm.addEventListener('keyup', function () {
				nfrm.querySelector('.avatar').src = 'https://api.adorable.io/avatars/285/' + this.value;
			});

			document.getElementById('add-stop').addEventListener('click', function (e) {
				var fragment = document.createElement('div');
				fragment.innerHTML = '<div class="stop"><span class="dot"></span><span class="caption">Country</span><span class="remove">&times;</span><input type="hidden" class="target" ></div>';
				fragment.querySelector('.caption').innerHTML = document.getElementById('target').value;
				fragment.querySelector('.target').value = document.getElementById('target').value;
				var stop = fragment.firstChild;
				fragment.querySelector('.remove').addEventListener('click', function () { stop.parentNode.removeChild(stop); refreshAPIResults(); });
				document.getElementById('stops').appendChild(fragment.firstChild);
			});

			document.getElementById('add-person').addEventListener('click', function (e) {
				addPerson();
			});
		}());
		</script>
		
		
		<script type="text/javascript">
			
		var api = document.querySelector('meta[name="vg.api"]').content;
		
		//Application logic
		depend(['autocomplete', 'm3/core/request', 'm3/core/collection'], function (autocomplete, request, collect) {
		
			var refreshAPIResults = window.refreshAPIResults = function () {

				var stops = collect(document.querySelectorAll('.target')).each(function (e) { return {country: e.value, reason: 'business'}; }).raw();
				var people = collect(document.querySelectorAll('.person')).each(function (e) { return { name : e.querySelector('.person-name').innerHTML, documents: [e.querySelector('input[name="passport"]').value]}; }).raw();

				console.log(document.querySelectorAll('.person'));
				console.log(people);

				request(api + '/itinerary/test.json', {
					people: people,
					stops: stops
				})
					.then(function (e) { document.getElementById('output').innerHTML = e; return e;})
					.then(JSON.parse)
					.then(function (r) {
						var recs = document.querySelector('#vg-recommendations');
						recs.innerHTML = '';

						for (var i = 0; i < r.payload.length; i++) {
							recs.appendChild(document.createElement('h2')).innerHTML = r.payload[i].name;

							for (var j in r.payload[i].stops) {
								if (!r.payload[i].stops.hasOwnProperty(j)) { continue; }
								recs.appendChild(document.createElement('div')).innerHTML = j;

								for (var k = 0; k < r.payload[i].stops[j].candidates.length; k++) {
									console.log(r.payload[i].stops[j].candidates[k]);
									var e = recs.appendChild(document.createElement('a'));
									var price = r.payload[i].stops[j].candidates[k][0].product? r.payload[i].stops[j].candidates[k][0].product.price.amt / 100 : '---';
									e.href = r.payload[i].stops[j].candidates[k][0].product? r.payload[i].stops[j].candidates[k][0].product.url : '#';
									e.style.display = 'block';
									e.innerHTML = r.payload[i].stops[j].candidates[k][0].name + price;
								}

								if (r.payload[i].stops[j].candidates.length === 0 && !r.payload[i].stops[j].granted) {
									var t = document.createElement('div');
									recs.appendChild(t);
									t.innerHTML = 'No visa is available, no entry will be granted';
								}

							}
						}
						console.log(r);
					})
					.catch(console.log);
			};
			autocomplete(document.querySelector('.autocomplete-target'), function (input, output) {
				request(api + '/search/find/country/' + input + '.json')
				.then(JSON.parse)
				.then(function (r) {
					var ret = {};
					var c = 0;
					
					for (var i in r) {
						if (!r.hasOwnProperty(i)) { continue; }
						if (c > 5) { continue; }
						ret[r[i].resource] = r[i].name;
						c++;
					}
					output(ret);
				});
			});
			
			autocomplete(document.querySelector('.autocomplete-passport'), function (input, output) {
				request(api + '/search/find/document/' + input + '.json')
				.then(JSON.parse)
				.then(function (r) {
					var ret = {};
					var c = 0;
					console.log(r);
					
					for (var i in r) {
						if (!r.hasOwnProperty(i)) { continue; }
						if (c > 5) { continue; }
						ret[r[i].resource] = r[i].name;
						c++;
					}
					output(ret);
				});
			});/**/
			
			document.getElementById('nationality-form').addEventListener('click', function() { setTimeout(refreshAPIResults , 200);}, false);/**/
		});
		</script>
	</body>
</html>
